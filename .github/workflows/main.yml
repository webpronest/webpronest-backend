name: Build & Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
          
      # - name: Set up Docker Buildx
      #   uses: docker/setup-buildx-action@v3

      # - name: Build Docker image
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: .
      #     file: ./Dockerfile
      #     push: false
      #     load: true
      #     tags: webpronest:${{ github.sha }}
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max

      - name: Create CI env file
        run: |
          cat <<-EOF > .env
          DATABASE_URL=postgresql+asyncpg://testuser:testpass@postgres:5432/testdb
          GOOGLE_CLIENT_ID=
          GOOGLE_CLIENT_SECRET=
          GOOGLE_REDIRECT_URI=
          JWT_SECRET=dummy_secret_key_for_ci
          JWT_ALGORITHM=RS256
          EOF
      
      - name: Verify env file
        run: |
          cat -A .env

      - name: Build & tag image
        run: |
          docker compose --profile ci build

      - name: Run Alembic migrations
        run: |
          docker compose --profile ci run --rm app_ci alembic upgrade head

      - name: Start container
        run: |
          docker compose --profile ci up -d

      - name: Health check
        run: |
          echo "Waiting for application to become healthy..."
          for i in {1..40}; do
            STATUS=$(docker compose --profile ci ps --services --filter "status=running")
            HEALTH=$(docker inspect --format='{{.State.Health.Status}}' $(docker compose --profile ci ps -q app_ci))
            echo "Current health: $HEALTH"
            if [ "$HEALTH" = "healthy" ]; then
              echo "Container is healthy!"
              exit 0
            fi
            docker compose --profile ci logs app_ci
            echo "Health not healthy yet... retrying ($i/40)"
            sleep 3
          done
          echo "Container failed health check!"
          docker compose --profile ci logs app_ci
          exit 1

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to production server (build on VPS, run migrations)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # Exit on any error
            set -e

            # Change to your project directory on the VPS (replace the path below)
            cd ${{ secrets.PROJECT_PATH }}

            # Ensure we're on the desired branch and up-to-date
            git fetch --all
            git reset --hard origin/main

            # Start production services using the `prod` profile (rebuild if needed)
            docker compose --profile prod build app_prod
            docker compose --profile prod run --rm app_prod alembic upgrade head
            docker compose --profile prod up -d app_prod

            # Prune old images to save space
            docker image prune -f